{% load static %}
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Customer Dashboard • Bookify</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Theme -->
  <link rel="stylesheet" href="{% static 'css/dashboard.css' %}">

  <!-- Flatpickr -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

  <!-- Inline styling for badges + cancel -->
  <style>
    .badge {
      display:inline-flex;
      align-items:center;
      padding:2px 10px;
      border-radius:999px;
      font-size:12px;
      font-weight:500;
      margin-left:8px;
    }
    .badge--pending {
      background:#fff7ed;
      color:#ea580c;
      border:1px solid #fed7aa;
    }
    .badge--confirmed {
      background:#dcfce7;
      color:#15803d;
      border:1px solid #bbf7d0;
    }
    .badge--cancelled {
      background:#fee2e2;
      color:#b91c1c;
      border:1px solid #fecaca;
    }

    .list--reservations li {
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
    }
    .res-main {
      flex:1;
      min-width:0;
    }
    .cancel-btn {
      border:none;
      background:transparent;
      color:#dc2626;
      font-size:13px;
      cursor:pointer;
      padding:2px 4px;
      white-space:nowrap;
    }
    .cancel-btn:hover { text-decoration:underline; }

    /* thumbnail image for restaurants */
    .thumb-img{
      width:100%;
      height:100%;
      border-radius:inherit;
      object-fit:cover;
      display:block;
    }
  </style>
</head>

<body>
<div class="wrap">

  <!-- HEADER -->
  <header class="topbar">
    <div class="hello">
      <div class="avatar">{{ request.user.first_name|default:request.user.email|slice:":1" }}</div>
      <div>
        <h1 class="title">Welcome back, {{ request.user.first_name|default:request.user.email }}</h1>
        <p class="muted">Discover restaurants and request a table in seconds.</p>
      </div>
    </div>
    <div class="actions">
      <a href="{% url 'home' %}" class="btn ghost">← Back home</a>
      <a href="{% url 'logout' %}" class="btn">Log out</a>
    </div>
  </header>

  <!-- MAIN CONTENT GRID -->
  <main class="grid">

    <!-- LEFT SIDE: BROWSE RESTAURANTS -->
    <section>
      <div class="panel">
        <div class="panel-head">
          <h2>Browse restaurants</h2>
          <form method="get" class="searchbar">
            <input type="text" name="q" value="{{ search_query }}" placeholder='Try "Italian" or "Downtown"'>
            <button class="btn brand" type="submit">Search</button>
          </form>
        </div>

        {% if not has_restaurants %}
          <div class="empty">No restaurants available yet.</div>
        {% endif %}

        <div class="cards">
          {% for item in restaurants %}
            {% with r=item.obj form=item.form hours=item.opening_hours %}
            <article class="card {% if active_restaurant_id == r.id %}active{% endif %}">
              <!-- Card header -->
              <div class="card-head">
                {% if r.photo %}
                  <div class="thumb" aria-hidden="true">
                    <img src="{{ r.photo.url }}" alt="{{ r.name }} photo" class="thumb-img">
                  </div>
                {% else %}
                  <div class="thumb" aria-hidden="true">{{ r.name|slice:":1" }}</div>
                {% endif %}
                <div class="info">
                  <h3 class="name">{{ r.name }}</h3>
                  <div class="meta">
                    <span>{{ r.cuisine }}</span><span class="dot"></span>
                    <span>{{ r.address }}</span>
                  </div>
                </div>
                <div class="city">{{ r.city|default:"" }}</div>
              </div>

              {% if r.description %}
                <p class="desc">{{ r.description }}</p>
              {% endif %}

              {% if hours %}
                <div class="hours-table">
                  {% for day, range in hours %}
                    <div class="row">
                      <span class="day">{{ day }}</span>
                      <span class="range">{{ range }}</span>
                    </div>
                  {% endfor %}
                </div>
              {% endif %}

              <!-- Reservation Form -->
              <form method="post" class="req-form" data-restaurant="{{ r.id }}">
                {% csrf_token %}
                {{ form.restaurant }}

                {% if form.non_field_errors %}
                  <div class="form-errors">{{ form.non_field_errors }}</div>
                {% endif %}

                <div class="row3">
                  <div class="field">
                    <label>Date</label>
                    {{ form.reservation_date }}
                  </div>
                  <div class="field">
                    <label>Time</label>
                    {{ form.reservation_time }}
                  </div>
                  <div class="field">
                    <label>Guests</label>
                    {{ form.party_size }}
                  </div>
                </div>

                <div class="field">
                  <label>Notes (optional)</label>
                  {{ form.notes }}
                </div>

                <div class="row-end">
                  <button class="btn brand" type="submit">Request table</button>
                </div>
              </form>
            </article>
            {% endwith %}
          {% endfor %}
        </div>
      </div>
    </section>

    <!-- RIGHT SIDE: UPCOMING + PAST -->
    <aside>

      <!-- UPCOMING -->
      <div class="panel">
        <h2>Upcoming reservations</h2>

        {% if upcoming_reservations %}
          <ul class="list list--reservations">
            {% for r in upcoming_reservations %}
              {% with inst=r.instance %}
              <li>
                <div class="res-main">
                  <strong>{{ inst.restaurant.name }}</strong><br>
                  {{ inst.reservation_date }} • {{ inst.reservation_time|time:"H:i" }} • {{ inst.party_size }} Guests

                  {% if inst.status == 'PENDING' %}
                    <span class="badge badge--pending">Pending</span>
                  {% elif inst.status == 'CONFIRMED' %}
                    <span class="badge badge--confirmed">Confirmed</span>
                  {% elif inst.status == 'CANCELLED' %}
                    <span class="badge badge--cancelled">Cancelled by you</span>
                  {% elif inst.status == 'DECLINED' %}
                    <span class="badge badge--cancelled">Declined by restaurant</span>
                  {% endif %}
                </div>

                {% if inst.status == 'PENDING' or inst.status == 'CONFIRMED' %}
                <form method="post" action="{% url 'cancel_reservation' inst.id %}"
                      onsubmit="return confirm('Cancel this reservation?');">
                  {% csrf_token %}
                  <button type="submit" class="cancel-btn">Cancel</button>
                </form>
                {% endif %}
              </li>
              {% endwith %}
            {% endfor %}
          </ul>
        {% else %}
          <div class="empty">You have no upcoming reservations yet. Pick a restaurant to get started.</div>
        {% endif %}
      </div>

      <!-- PAST & CANCELLED -->
      {% if past_reservations %}
      <div class="panel">
        <h2>Past &amp; Cancelled Reservations</h2>
        <ul class="list">
          {% for r in past_reservations %}
            {% with inst=r.instance %}
            <li>
              <strong>{{ inst.restaurant.name }}</strong>
              <div class="muted">
                {{ inst.reservation_date }} • {{ inst.reservation_time|time:"H:i" }} • {{ inst.party_size }} Guests

                {% if inst.status == 'CANCELLED' %}
                  <span class="badge badge--cancelled">Cancelled by you</span>
                {% elif inst.status == 'DECLINED' %}
                  <span class="badge badge--cancelled">Declined by restaurant</span>
                {% elif inst.status == 'CONFIRMED' %}
                  <span class="badge badge--confirmed">Confirmed</span>
                {% elif inst.status == 'PENDING' %}
                  <span class="badge badge--pending">Pending</span>
                {% endif %}
              </div>
            </li>
            {% endwith %}
          {% endfor %}
        </ul>
      </div>
      {% endif %}

    </aside>
  </main>
</div>

<script src="{% static 'js/pickers.js' %}"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  if (!window.flatpickr) return;

  document.querySelectorAll('input[name="reservation_date"]').forEach(el => {
    flatpickr(el, {
      altInput:true, altFormat:"D, M j, Y",
      dateFormat:"Y-m-d",
      minDate:"today"
    });
  });

  document.querySelectorAll('input[name="reservation_time"]').forEach(el => {
    flatpickr(el, {
      enableTime:true,
      noCalendar:true,
      time_24hr:true,
      dateFormat:"H:i",
      minuteIncrement:15
    });
  });
});
</script>

</body>
</html>

