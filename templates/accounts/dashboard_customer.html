{% load static %}
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Customer Dashboard • Bookify</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Theme -->
  <link rel="stylesheet" href="{% static 'css/dashboard.css' %}">

  <!-- Flatpickr -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

  <!-- Inline styling for badges + cancel -->
  <style>
    .badge {
      display:inline-flex;
      align-items:center;
      padding:2px 10px;
      border-radius:999px;
      font-size:12px;
      font-weight:500;
      margin-left:8px;
    }
    .badge--pending {
      background:#fff7ed;
      color:#ea580c;
      border:1px solid #fed7aa;
    }
    .badge--confirmed {
      background:#dcfce7;
      color:#15803d;
      border:1px solid #bbf7d0;
    }
    .badge--cancelled {
      background:#fee2e2;
      color:#b91c1c;
      border:1px solid #fecaca;
    }

    .list--reservations li {
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
    }
    .res-main {
      flex:1;
      min-width:0;
    }
    .cancel-btn {
      border:none;
      background:transparent;
      color:#dc2626;
      font-size:13px;
      cursor:pointer;
      padding:2px 4px;
      white-space:nowrap;
    }
    .cancel-btn:hover { text-decoration:underline; }

    /* thumbnail image for restaurants */
    .thumb-img{
      width:100%;
      height:100%;
      border-radius:inherit;
      object-fit:cover;
      display:block;
    }

  /* Wrapper inside the white card */
.browse-section{
  padding: 12px 12px 0 12px;
}

/* Title spacing */
.browse-title{
  font-size: 20px;
  font-weight: 800;
  margin: 0 0 12px 0;
}

/* Search panel card */
.resto-search-panel{
  background:#fff;
  border:1px solid #e6e7eb;
  border-radius:18px;
  padding:12px;
  box-shadow:0 6px 24px rgba(0,0,0,.06);
  margin-bottom:18px;
}

/* Grid layout like the Browse page */
.resto-filters{
  display:grid;
  grid-template-columns:2fr 1.4fr auto;
  gap:10px;
}

/* Inputs in the search panel */
.resto-filters input{
  width:100%;
  height:44px;
  padding:0 14px;
  border-radius:12px;
  border:1px solid #e6e7eb;
  background:#fff;
  font:inherit;
}

/* Orange Search button */
.btn-search{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  height:44px;
  padding:0 18px;
  border-radius:12px;
  border:none;
  background:#ff7a1a;
  color:#fff;
  font-weight:600;
  cursor:pointer;
}
.btn-search:hover{ background:#ff6a00; }

/* Chips row under the inputs */
.resto-chips{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  margin-top:10px;
  grid-column:1 / -1;
}

/* Same chip style as Browse page */
.chip{
  height:32px;
  padding:0 12px;
  border-radius:999px;
  background:#f3f4f6;
  border:1px solid #e6e7eb;
  font-size:13px;
}
.chip:hover{ background:#eef0f3; }

/* Visually hidden labels */
.sr-only{
  position:absolute;
  left:-9999px;
}


.browse-section{
  padding: 20px 20px 0 20px;  /* more air inside the big white card */
}

/* Bigger title */
.browse-title{
  font-size: 26px;
  font-weight: 800;
  margin: 0 0 18px 0;
}

/* Search panel card */
.resto-search-panel{
  background:#fff;
  border:1px solid #e6e7eb;
  border-radius:18px;
  padding:12px;
  box-shadow:0 6px 24px rgba(0,0,0,.06);
  margin-bottom:32px;  /* more gap before restaurant list */
}

/* NEW: separator between search and restaurants */
.restaurant-list{
  padding-top: 12px;
  border-top: 1px solid #f3f4f6;  /* light line */
}



  </style>
</head>

<body>
<div class="wrap">

  <!-- HEADER -->
  <header class="topbar">
    <div class="hello">
      <div class="avatar">{{ request.user.first_name|default:request.user.email|slice:":1" }}</div>
      <div>
        <h1 class="title">Welcome back, {{ request.user.first_name|default:request.user.email }}</h1>
        <p class="muted">Discover restaurants and request a table in seconds.</p>
      </div>
    </div>
    <div class="actions">
      <a href="{% url 'home' %}" class="btn ghost">← Back home</a>
      <a href="{% url 'logout' %}" class="btn">Log out</a>
    </div>
  </header>

  <!-- MAIN CONTENT GRID -->
  <main class="grid">

    <!-- LEFT SIDE: BROWSE RESTAURANTS -->
    <section>
      <div class="panel">
        <div class="panel-head">
          <div class="browse-section">
            <div class="browse-section">
              <h2 class="browse-title">Browse restaurants</h2>
            
              <!-- Search panel -->
              <div class="resto-search-panel" role="region" aria-label="Filters">
                <form class="resto-filters" method="get">
                  <label class="sr-only" for="q">Search</label>
                  <input id="q" type="text" name="q"
                         placeholder="Search by name or address…"
                         value="{{ q|default:'' }}">
            
                  <label class="sr-only" for="cuisine">Cuisine</label>
                  <input id="cuisine" type="text" name="cuisine"
                         placeholder="Cuisine (e.g., Italian, Sushi…)"
                         value="{{ cuisine|default:'' }}">
            
                  <button class="btn-search" type="submit">Search</button>
            
                  <div class="resto-chips" aria-label="Quick categories">
                    <button type="submit" name="cuisine" value="Lebanese" class="chip">Lebanese</button>
                    <button type="submit" name="cuisine" value="Burger"   class="chip">Burger</button>
                    <button type="submit" name="cuisine" value="Sushi"    class="chip">Sushi</button>
                    <button type="submit" name="cuisine" value="Pizza"    class="chip">Pizza</button>
                    <button type="submit" name="cuisine" value="Cafe"     class="chip">Cafe</button>
                  </div>
                </form>
              </div>
            
              <div class="restaurant-list">
                {% for r in restaurants %}
                  <!-- restaurant card -->
                  
                {% endfor %}
              </div>
              
            </div>
            
          </div>
          
          
        </div>

        {% if not has_restaurants %}
          <div class="empty">No restaurants available yet.</div>
        {% endif %}

        <div class="cards">
          {% for item in restaurants %}
            {% with r=item.obj form=item.form hours=item.opening_hours %}
            <article class="card {% if active_restaurant_id == r.id %}active{% endif %}">
              <!-- Card header -->
              <div class="card-head">
                {% if r.photo %}
                  <div class="thumb" aria-hidden="true">
                    <img src="{{ r.photo.url }}" alt="{{ r.name }} photo" class="thumb-img">
                  </div>
                {% else %}
                  <div class="thumb" aria-hidden="true">{{ r.name|slice:":1" }}</div>
                {% endif %}
                <div class="info">
                  <h3 class="name">{{ r.name }}</h3>
                  <div class="meta">
                    <span>{{ r.cuisine }}</span><span class="dot"></span>
                    <span>{{ r.address }}</span>
                  </div>
                </div>
                <div class="city">{{ r.city|default:"" }}</div>
              </div>

              {% if r.description %}
                <p class="desc">{{ r.description }}</p>
              {% endif %}

              {% if hours %}
                <div class="hours-table">
                  {% for day, range in hours %}
                    <div class="row">
                      <span class="day">{{ day }}</span>
                      <span class="range">{{ range }}</span>
                    </div>
                  {% endfor %}
                </div>
              {% endif %}

              <!-- Reservation Form -->
              <form method="post" class="req-form" data-restaurant="{{ r.id }}">
                {% csrf_token %}
                {{ form.restaurant }}

                {% if form.non_field_errors %}
                  <div class="form-errors">{{ form.non_field_errors }}</div>
                {% endif %}

                <div class="row3">
                  <div class="field">
                    <label>Date</label>
                    {{ form.reservation_date }}
                  </div>
                  <div class="field">
                    <label>Time</label>
                    {{ form.reservation_time }}
                  </div>
                  <div class="field">
                    <label>Guests</label>
                    {{ form.party_size }}
                  </div>
                </div>

                <div class="field">
                  <label>Notes (optional)</label>
                  {{ form.notes }}
                </div>

                <div class="row-end">
                  <button class="btn brand" type="submit">Request table</button>
                </div>
              </form>
            </article>
            {% endwith %}
          {% endfor %}
        </div>
      </div>
    </section>

    <!-- RIGHT SIDE: UPCOMING + PAST -->
    <aside>

      <!-- UPCOMING -->
      <div class="panel">
        <h2>Upcoming reservations</h2>

        {% if upcoming_reservations %}
          <ul class="list list--reservations">
            {% for r in upcoming_reservations %}
              {% with inst=r.instance %}
              <li>
                <div class="res-main">
                  <strong>{{ inst.restaurant.name }}</strong><br>
                  {{ inst.reservation_date }} • {{ inst.reservation_time|time:"H:i" }} • {{ inst.party_size }} Guests

                  {% if inst.status == 'PENDING' %}
                    <span class="badge badge--pending">Pending</span>
                  {% elif inst.status == 'CONFIRMED' %}
                    <span class="badge badge--confirmed">Confirmed</span>
                  {% elif inst.status == 'CANCELLED' %}
                    <span class="badge badge--cancelled">Cancelled by you</span>
                  {% elif inst.status == 'DECLINED' %}
                    <span class="badge badge--cancelled">Declined by restaurant</span>
                  {% endif %}
                </div>

                {% if inst.status == 'PENDING' or inst.status == 'CONFIRMED' %}
                <form method="post" action="{% url 'cancel_reservation' inst.id %}"
                      onsubmit="return confirm('Cancel this reservation?');">
                  {% csrf_token %}
                  <button type="submit" class="cancel-btn">Cancel</button>
                </form>
                {% endif %}
              </li>
              {% endwith %}
            {% endfor %}
          </ul>
        {% else %}
          <div class="empty">You have no upcoming reservations yet. Pick a restaurant to get started.</div>
        {% endif %}
      </div>

      <!-- PAST & CANCELLED -->
      {% if past_reservations %}
      <div class="panel">
        <h2>Past &amp; Cancelled Reservations</h2>
        <ul class="list">
          {% for r in past_reservations %}
            {% with inst=r.instance %}
            <li>
              <strong>{{ inst.restaurant.name }}</strong>
              <div class="muted">
                {{ inst.reservation_date }} • {{ inst.reservation_time|time:"H:i" }} • {{ inst.party_size }} Guests

                {% if inst.status == 'CANCELLED' %}
                  <span class="badge badge--cancelled">Cancelled by you</span>
                {% elif inst.status == 'DECLINED' %}
                  <span class="badge badge--cancelled">Declined by restaurant</span>
                {% elif inst.status == 'CONFIRMED' %}
                  <span class="badge badge--confirmed">Confirmed</span>
                {% elif inst.status == 'PENDING' %}
                  <span class="badge badge--pending">Pending</span>
                {% endif %}
              </div>
            </li>
            {% endwith %}
          {% endfor %}
        </ul>
      </div>
      {% endif %}

    </aside>
  </main>
</div>

<script src="{% static 'js/pickers.js' %}"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  if (!window.flatpickr) return;

  document.querySelectorAll('input[name="reservation_date"]').forEach(el => {
    flatpickr(el, {
      altInput:true, altFormat:"D, M j, Y",
      dateFormat:"Y-m-d",
      minDate:"today"
    });
  });

  document.querySelectorAll('input[name="reservation_time"]').forEach(el => {
    flatpickr(el, {
      enableTime:true,
      noCalendar:true,
      time_24hr:true,
      dateFormat:"H:i",
      minuteIncrement:15
    });
  });
});
</script>

</body>
</html>
