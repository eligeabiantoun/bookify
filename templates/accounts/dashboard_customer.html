{% load static %}
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Customer Dashboard • Bookify</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Light theme to match browse page -->
  <link rel="stylesheet" href="{% static 'css/dashboard.css' %}">

  <!-- Flatpickr (calendar & time) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
</head>
<body>
  <div class="wrap">
    <!-- TOP BAR -->
    <header class="topbar">
      <div class="hello">
        <div class="avatar">{{ request.user.first_name|default:request.user.email|slice:":1" }}</div>
        <div>
          <h1 class="title">Welcome back, {{ request.user.first_name|default:request.user.email }}</h1>
          <p class="muted">Discover restaurants and request a table in seconds.</p>
        </div>
      </div>
      <div class="actions">
        <a href="{% url 'home' %}" class="btn ghost">← Back home</a>
        <a href="{% url 'logout' %}" class="btn">Log out</a>
      </div>
    </header>

    <!-- LAYOUT -->
    <main class="grid">
      <!-- LEFT: BROWSE + REQUEST -->
      <section>
        <div class="panel">
          <div class="panel-head">
            <h2>Browse restaurants</h2>
            <form method="get" class="searchbar">
              <input type="text" name="q" value="{{ search_query }}" placeholder='Try "Italian" or "Downtown"'>
              <button class="btn brand" type="submit">Search</button>
            </form>
          </div>

          {% if not has_restaurants %}
            <div class="empty">No restaurants available yet.</div>
          {% endif %}

          <div class="cards">
            {% for item in restaurants %}
              {% with r=item.obj form=item.form hours=item.opening_hours %}
              <article class="card {% if active_restaurant_id == r.id %}active{% endif %}">
                <!-- Card header -->
                <div class="card-head">
                  <div class="thumb">{{ r.name|slice:":1" }}</div>
                  <div class="info">
                    <h3 class="name">{{ r.name }}</h3>
                    <div class="meta">
                      <span>{{ r.cuisine }}</span><span class="dot"></span>
                      <span>{{ r.address }}</span>
                    </div>
                  </div>
                  <div class="city">{{ r.city|default:"" }}</div>
                </div>

                {% if r.description %}
                  <p class="desc">{{ r.description }}</p>
                {% endif %}

                {% if r.opening_time and r.closing_time %}
                  <div class="hours-row">
                    <span class="label">Daily</span>
                    <span class="time">{{ r.opening_time|time:"H:i" }} – {{ r.closing_time|time:"H:i" }}</span>
                  </div>
                {% elif hours %}
                  <div class="hours-table">
                    {% for day, range in hours %}
                      <div class="row">
                        <span class="day">{{ day }}</span>
                        <span class="range">{{ range }}</span>
                      </div>
                    {% endfor %}
                  </div>
                {% endif %}

                <!-- Reservation form -->
                <form method="post" class="req-form" data-restaurant="{{ r.id }}">
                  {% csrf_token %}
                  {{ form.restaurant }} {# hidden field #}

                  {% if form.non_field_errors %}
                    <div class="form-errors">{{ form.non_field_errors }}</div>
                  {% endif %}

                  <div class="row3">
                    <div class="field">
                      <label for="{{ form.reservation_date.id_for_label }}">Date</label>
                      {{ form.reservation_date }}
                      {% if form.reservation_date.errors %}
                        <div class="form-errors">{{ form.reservation_date.errors }}</div>
                      {% endif %}
                    </div>

                    <div class="field">
                      <label for="{{ form.reservation_time.id_for_label }}">Time</label>
                      {{ form.reservation_time }}
                      {% if form.reservation_time.errors %}
                        <div class="form-errors">{{ form.reservation_time.errors }}</div>
                      {% endif %}
                    </div>

                    <div class="field">
                      <label for="{{ form.party_size.id_for_label }}">Guests</label>
                      {{ form.party_size }}
                      {% if form.party_size.errors %}
                        <div class="form-errors">{{ form.party_size.errors }}</div>
                      {% endif %}
                    </div>
                  </div>

                  <div class="field">
                    <label for="{{ form.notes.id_for_label }}">Notes (optional)</label>
                    {{ form.notes }}
                    {% if form.notes.errors %}
                      <div class="form-errors">{{ form.notes.errors }}</div>
                    {% endif %}
                  </div>

                  <div class="row-end">
                    <button class="btn brand" type="submit">Request table</button>
                  </div>
                </form>
              </article>
              {% endwith %}
            {% endfor %}
          </div>
        </div>
      </section>

      <!-- RIGHT: UPCOMING / RECENT -->
      <aside>
        <div class="panel">
          <h2>Upcoming reservations</h2>
          {% if upcoming_reservations %}
            <ul class="list">
              {% for r in upcoming_reservations %}
                <li>
                  <strong>{{ r.instance.restaurant.name }}</strong>
                  <div class="muted">
                    {{ r.instance.reservation_date }} • {{ r.instance.reservation_time|time:"H:i" }}
                  </div>
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <div class="empty">You have no upcoming reservations yet. Pick a restaurant to get started.</div>
          {% endif %}
        </div>

        {% if past_reservations %}
          <div class="panel">
            <h2>Recent reservations</h2>
            <ul class="list">
              {% for r in past_reservations %}
                <li>
                  <strong>{{ r.instance.restaurant.name }}</strong>
                  <div class="muted">
                    {{ r.instance.reservation_date }} • {{ r.instance.reservation_time|time:"H:i" }}
                  </div>
                </li>
              {% endfor %}
            </ul>
          </div>
        {% endif %}
      </aside>
    </main>
  </div>

 <!-- Keep or remove depending on if you created pickers.js -->
<script src="{% static 'js/pickers.js' %}"></script>

<!-- Inline calendar/time picker initializer -->
<script>
  document.addEventListener('DOMContentLoaded', function () {
    if (!window.flatpickr) { console.warn('Flatpickr failed to load'); return; }

    // Attach date pickers
    document.querySelectorAll('input.datepicker, input[name="reservation_date"]').forEach(function (el) {
      try { el.setAttribute('type', 'text'); } catch (e) {}
      flatpickr(el, {
        altInput: true,
        altFormat: "D, M j, Y",
        dateFormat: "Y-m-d",
        minDate: "today"
      });
    });

    // Attach time pickers
    document.querySelectorAll('input.timepicker, input[name="reservation_time"]').forEach(function (el) {
      try { el.setAttribute('type', 'text'); } catch (e) {}
      flatpickr(el, {
        enableTime: true,
        noCalendar: true,
        dateFormat: "H:i",
        time_24hr: true,
        minuteIncrement: 15
      });
    });
  });
</script>
</body>
</html>
